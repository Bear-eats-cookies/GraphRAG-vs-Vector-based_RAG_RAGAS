# -*- coding: utf-8 -*-
# @Time : 2025/9/5 16:24
# @Author : æ®·éŸµæ™º
# @FileName: vector_rag.py
# @Software: PyCharm
# Vector-based RAG å®ç°

"""
Vector-based RAG (Retrieval-Augmented Generation) ç³»ç»Ÿ

è¿™ä¸ªè„šæœ¬å®ç°äº†åŸºäºå‘é‡ç›¸ä¼¼æ€§çš„æ£€ç´¢å¢å¼ºç”Ÿæˆç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
1. æ–‡æ¡£åŠ è½½å’Œé¢„å¤„ç†ï¼ˆåˆ†å—ï¼‰
2. æ–‡æ¡£å‘é‡åŒ–å’Œç´¢å¼•æ„å»º
3. åŸºäºè¯­ä¹‰ç›¸ä¼¼æ€§çš„æ–‡æ¡£æ£€ç´¢
4. æ£€ç´¢ç»“æœé‡æ’åºä¼˜åŒ–
5. ç»“åˆæ£€ç´¢å†…å®¹ç”Ÿæˆå‡†ç¡®å›ç­”

ä¸ GraphRAG çš„åŒºåˆ«ï¼š
- GraphRAGï¼šåŸºäºçŸ¥è¯†å›¾è°±çš„ç»“æ„åŒ–æ£€ç´¢ï¼Œé€‚åˆå¤æ‚å…³ç³»æ¨ç†
- Vector RAGï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼æ€§çš„æ–‡æ¡£æ£€ç´¢ï¼Œé€‚åˆç›´æ¥ä¿¡æ¯æŸ¥æ‰¾

ä¸»è¦ç»„ä»¶ï¼š
- æ–‡æ¡£åˆ†å—å™¨ï¼šå°†é•¿æ–‡æ¡£åˆ‡åˆ†ä¸ºå¯ç®¡ç†çš„ç‰‡æ®µ
- å‘é‡å­˜å‚¨ï¼šä½¿ç”¨ FAISS è¿›è¡Œé«˜æ•ˆçš„ç›¸ä¼¼æ€§æœç´¢
- é‡æ’åºå™¨ï¼šä½¿ç”¨ FlashrankRerank ä¼˜åŒ–æ£€ç´¢ç»“æœæ’åº
- ç”Ÿæˆå™¨ï¼šä½¿ç”¨ GPT æ¨¡å‹åŸºäºæ£€ç´¢å†…å®¹ç”Ÿæˆå›ç­”

æŠ€æœ¯æ¶æ„ï¼š
- æ•°æ®å±‚ï¼šåŸå§‹æ–‡æ¡£çš„åˆ†å—å¤„ç†
- åµŒå…¥å±‚ï¼šæ–‡æ¡£å‘é‡åŒ–å’Œç›¸ä¼¼æ€§è®¡ç®—
- å­˜å‚¨å±‚ï¼šFAISS å‘é‡æ•°æ®åº“
- æ£€ç´¢å±‚ï¼šMMR ç®—æ³•å’Œé‡æ’åºä¼˜åŒ–
- ç”Ÿæˆå±‚ï¼šåŸºäºä¸Šä¸‹æ–‡çš„ LLM å›ç­”ç”Ÿæˆ
"""
"""
ä»£ç åŠŸèƒ½æ€»ç»“
è¿™ä¸ª Vector-based RAGï¼ˆåŸºäºå‘é‡çš„æ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿçš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š

ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
æ–‡æ¡£é¢„å¤„ç† - åŠ è½½æ–‡æœ¬æ–‡ä»¶å¹¶æ™ºèƒ½åˆ†å—ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§
å‘é‡åŒ–ç´¢å¼• - ä½¿ç”¨ OpenAI åµŒå…¥æ¨¡å‹å°†æ–‡æ¡£è½¬æ¢ä¸ºè¯­ä¹‰å‘é‡
é«˜æ•ˆæ£€ç´¢ - åŸºäº FAISS å‘é‡æ•°æ®åº“è¿›è¡Œå¿«é€Ÿç›¸ä¼¼æ€§æœç´¢
ç»“æœä¼˜åŒ– - ä½¿ç”¨ MMR ç®—æ³•å’Œ FlashrankRerank æå‡æ£€ç´¢è´¨é‡
æ™ºèƒ½é—®ç­” - ç»“åˆæ£€ç´¢å†…å®¹ä½¿ç”¨ GPT æ¨¡å‹ç”Ÿæˆå‡†ç¡®å›ç­”
ğŸ”§ æŠ€æœ¯æ¶æ„
æ•°æ®å±‚ï¼šæ–‡æ¡£åˆ†å—å’Œé¢„å¤„ç†
åµŒå…¥å±‚ï¼štext-embedding-3-small æ¨¡å‹è¿›è¡Œå‘é‡åŒ–
å­˜å‚¨å±‚ï¼šFAISS å‘é‡æ•°æ®åº“æ”¯æŒé«˜æ•ˆæœç´¢
æ£€ç´¢å±‚ï¼šMMR ç®—æ³• + FlashrankRerank é‡æ’åº
ç”Ÿæˆå±‚ï¼šGPT-4o-mini åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆå›ç­”
ğŸš€ å·¥ä½œæµç¨‹
åŠ è½½åŸå§‹æ–‡æ¡£å¹¶åˆ†å‰²ä¸º 700 å­—ç¬¦çš„å—ï¼ˆ50 å­—ç¬¦é‡å ï¼‰
ä½¿ç”¨åµŒå…¥æ¨¡å‹å°†æ‰€æœ‰æ–‡æ¡£å—è½¬æ¢ä¸ºå‘é‡
æ„å»º FAISS å‘é‡æ•°æ®åº“å¹¶åˆ›å»ºæ£€ç´¢å™¨
æ¥æ”¶ç”¨æˆ·æŸ¥è¯¢å¹¶è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º
ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦æœç´¢æœ€ç›¸å…³çš„æ–‡æ¡£å—
åº”ç”¨ MMR ç®—æ³•å’Œé‡æ’åºä¼˜åŒ–ç»“æœ
é€‰æ‹©å‰ 3 ä¸ªæœ€ç›¸å…³æ–‡æ¡£ä½œä¸ºä¸Šä¸‹æ–‡
ä½¿ç”¨ LLM åŸºäºæ£€ç´¢å†…å®¹ç”Ÿæˆå›ç­”
ğŸ’¡ ç³»ç»Ÿä¼˜åŠ¿
è¯­ä¹‰ç†è§£ï¼šä¸ä¾èµ–å…³é”®è¯åŒ¹é…ï¼Œç†è§£æŸ¥è¯¢çš„çœŸå®æ„å›¾
å¿«é€Ÿæ£€ç´¢ï¼šFAISS æä¾›æ¯«ç§’çº§çš„å‘é‡æœç´¢æ€§èƒ½
ç²¾ç¡®åŒ¹é…ï¼šé‡æ’åºæœºåˆ¶è¿›ä¸€æ­¥æå‡ç›¸å…³æ€§
ä¸Šä¸‹æ–‡ä¿æŒï¼šæ–‡æ¡£åˆ†å—é‡å ç¡®ä¿ä¿¡æ¯å®Œæ•´æ€§
æ‰©å±•æ€§å¼ºï¼šå¯å¤„ç†å¤§è§„æ¨¡æ–‡æ¡£é›†åˆ
è¿™ä¸ªç³»ç»Ÿç‰¹åˆ«é€‚åˆå¤„ç†åŸºäºæ–‡æ¡£çš„é—®ç­”ä»»åŠ¡ï¼Œå¦‚è´¢åŠ¡æŠ¥å‘Šåˆ†æã€æŠ€æœ¯æ–‡æ¡£æŸ¥è¯¢ã€çŸ¥è¯†åº“æ£€ç´¢ç­‰åœºæ™¯ã€‚

"""
import os
from langchain_community.document_loaders import TextLoader
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_community.vectorstores.utils import DistanceStrategy
from langchain.retrievers.document_compressors import FlashrankRerank
from langchain.retrievers import ContextualCompressionRetriever
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain.schema import HumanMessage, SystemMessage

# ==================== é…ç½®éƒ¨åˆ† ====================
# é…ç½® OpenAI API ç¯å¢ƒå˜é‡
# æ³¨æ„ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ç®¡ç† API å¯†é’¥
os.environ["OPENAI_API_KEY"] = 'OPENAI_API_KEY'
os.environ["OPENAI_API_BASE"] = 'OPENAI_API_BASE'

# ==================== æ¨¡å‹åˆå§‹åŒ– ====================
# åˆå§‹åŒ–å¤§è¯­è¨€æ¨¡å‹ (LLM)
# ç”¨äºåŸºäºæ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹ç”Ÿæˆæœ€ç»ˆå›ç­”
llm = ChatOpenAI(
    api_key=os.environ["OPENAI_API_KEY"],
    base_url=os.environ["OPENAI_API_BASE"],
    model="gpt-4o-mini"                     # ä½¿ç”¨ GPT-4o-mini æ¨¡å‹è¿›è¡Œæ–‡æœ¬ç”Ÿæˆ
)

# åˆå§‹åŒ–åµŒå…¥æ¨¡å‹
# ç”¨äºå°†æ–‡æ¡£å’ŒæŸ¥è¯¢è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºï¼Œæ”¯æŒè¯­ä¹‰ç›¸ä¼¼æ€§è®¡ç®—
embedding_model = OpenAIEmbeddings(
    api_key=os.environ["OPENAI_API_KEY"],
    base_url=os.environ["OPENAI_API_BASE"],
    model="text-embedding-3-small"          # ä½¿ç”¨ text-embedding-3-small è¿›è¡Œå‘é‡åŒ–
)

# ==================== æ–‡æ¡£åŠ è½½ä¸é¢„å¤„ç† ====================
# åŠ è½½åŸå§‹æ–‡æ¡£
# TextLoader ç”¨äºè¯»å–çº¯æ–‡æœ¬æ–‡ä»¶ï¼Œæ”¯æŒæŒ‡å®šç¼–ç æ ¼å¼
loader = TextLoader("ragtest/ragtest/input/unh_data.txt", encoding='utf-8')
pages = loader.load()

# æ–‡æ¡£åˆ†å—å¤„ç†
# RecursiveCharacterTextSplitter é€’å½’åœ°å°†é•¿æ–‡æ¡£åˆ†å‰²ä¸ºè¾ƒå°çš„å—
# è¿™æ ·åšçš„ç›®çš„ï¼š
# 1. ç¡®ä¿æ¯ä¸ªå—çš„å¤§å°é€‚åˆåµŒå…¥æ¨¡å‹å¤„ç†
# 2. æé«˜æ£€ç´¢çš„ç²¾ç¡®æ€§ï¼ˆé¿å…æ— å…³ä¿¡æ¯å¹²æ‰°ï¼‰
# 3. æ§åˆ¶ç”Ÿæˆæ—¶çš„ä¸Šä¸‹æ–‡é•¿åº¦
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=700,                         # æ¯ä¸ªæ–‡æ¡£å—çš„æœ€å¤§å­—ç¬¦æ•°
    chunk_overlap=50,                       # ç›¸é‚»å—ä¹‹é—´çš„é‡å å­—ç¬¦æ•°ï¼ˆä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§ï¼‰
    length_function=len,                    # ä½¿ç”¨å­—ç¬¦é•¿åº¦ä½œä¸ºåˆ†å‰²ä¾æ®
    is_separator_regex=False                # åˆ†éš”ç¬¦ä¸ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼
)

# æ‰§è¡Œæ–‡æ¡£åˆ†å—
docs = text_splitter.split_documents(pages)
print(f"ğŸ“„ æ–‡æ¡£å·²åˆ†å‰²ä¸º {len(docs)} ä¸ªå—")

# ==================== å‘é‡æ•°æ®åº“æ„å»º ====================
# ä½¿ç”¨ FAISS æ„å»ºå‘é‡æ•°æ®åº“
# FAISS (Facebook AI Similarity Search) æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„ç›¸ä¼¼æ€§æœç´¢åº“
# åŠŸèƒ½ï¼šå°†æ–‡æ¡£å—è½¬æ¢ä¸ºå‘é‡å¹¶å»ºç«‹ç´¢å¼•ï¼Œæ”¯æŒå¿«é€Ÿç›¸ä¼¼æ€§æœç´¢
faiss_db = FAISS.from_documents(
    docs,                                   # è¾“å…¥çš„æ–‡æ¡£å—åˆ—è¡¨
    embedding_model,                        # åµŒå…¥æ¨¡å‹ï¼Œç”¨äºå‘é‡åŒ–æ–‡æ¡£
    distance_strategy=DistanceStrategy.COSINE  # ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ä½œä¸ºè·ç¦»åº¦é‡
)

# åˆ›å»ºæ£€ç´¢å™¨
# æ£€ç´¢å™¨è´Ÿè´£æ ¹æ®æŸ¥è¯¢æ‰¾åˆ°æœ€ç›¸å…³çš„æ–‡æ¡£å—
retriever = faiss_db.as_retriever(
    search_kwargs={"k": 10},                # æ£€ç´¢å‰ 10 ä¸ªæœ€ç›¸å…³çš„æ–‡æ¡£å—
    search_type="mmr"                       # ä½¿ç”¨ MMR (Maximal Marginal Relevance) ç®—æ³•
)                                          # MMR åœ¨ç›¸å…³æ€§å’Œå¤šæ ·æ€§ä¹‹é—´å–å¾—å¹³è¡¡ï¼Œé¿å…æ£€ç´¢ç»“æœè¿‡äºç›¸ä¼¼

print("ğŸ” FAISS å‘é‡æ•°æ®åº“æ„å»ºå®Œæˆ")

# ==================== æ£€ç´¢ç»“æœé‡æ’åº ====================
# é…ç½® FlashrankRerank é‡æ’åºå™¨
# FlashrankRerank æ˜¯ä¸€ä¸ªè½»é‡çº§çš„é‡æ’åºæ¨¡å‹ï¼Œç”¨äºä¼˜åŒ–æ£€ç´¢ç»“æœçš„æ’åº
# ä½œç”¨ï¼šåœ¨åˆæ­¥æ£€ç´¢ç»“æœçš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥æå‡æœ€ç›¸å…³æ–‡æ¡£çš„æ’å
try:
    import flashrank
    from flashrank import Ranker
    
    # åˆå§‹åŒ– Flashrank æ’åºå™¨
    ranker = Ranker()
    compressor = FlashrankRerank(model=ranker)
    
    print("âœ… Flashrank é‡æ’åºå™¨å·²å¯ç”¨")
except ImportError:
    # å¦‚æœ Flashrank æœªå®‰è£…ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ£€ç´¢å™¨
    print("âš ï¸ Flashrank æœªå®‰è£…ï¼Œä½¿ç”¨é»˜è®¤æ£€ç´¢å™¨")
    compression_retriever = retriever
else:
    # åˆ›å»ºä¸Šä¸‹æ–‡å‹ç¼©æ£€ç´¢å™¨
    # ç»“åˆåŸºç¡€æ£€ç´¢å™¨å’Œé‡æ’åºå™¨ï¼Œæä¾›æ›´ç²¾ç¡®çš„æ£€ç´¢ç»“æœ
    compression_retriever = ContextualCompressionRetriever(
        base_compressor=compressor,         # é‡æ’åºå‹ç¼©å™¨
        base_retriever=retriever            # åŸºç¡€æ£€ç´¢å™¨
    )
    print("âœ… ä¸Šä¸‹æ–‡å‹ç¼©æ£€ç´¢å™¨å·²é…ç½®")

# ==================== æŸ¥è¯¢æ‰§è¡Œå‡½æ•° ====================
def run_vector_rag_query(query):
    """
    è¿è¡ŒåŸºäºå‘é‡çš„ RAG æŸ¥è¯¢ï¼Œè¿”å›ç”Ÿæˆçš„å›ç­”
    
    Args:
        query (str): ç”¨æˆ·çš„æŸ¥è¯¢é—®é¢˜
    
    Returns:
        str: åŸºäºæ£€ç´¢æ–‡æ¡£ç”Ÿæˆçš„å›ç­”
    
    å·¥ä½œæµç¨‹ï¼š
    1. å°†æŸ¥è¯¢è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º
    2. åœ¨å‘é‡æ•°æ®åº“ä¸­æœç´¢æœ€ç›¸å…³çš„æ–‡æ¡£å—
    3. ä½¿ç”¨é‡æ’åºå™¨ä¼˜åŒ–æ£€ç´¢ç»“æœ
    4. é€‰æ‹©å‰3ä¸ªæœ€ç›¸å…³çš„æ–‡æ¡£ä½œä¸ºä¸Šä¸‹æ–‡
    5. æ„å»ºåŒ…å«æŸ¥è¯¢å’Œæ–‡æ¡£çš„æç¤º
    6. ä½¿ç”¨ LLM åŸºäºæ£€ç´¢å†…å®¹ç”Ÿæˆå›ç­”
    
    æŠ€æœ¯ç‰¹ç‚¹ï¼š
    - è¯­ä¹‰æœç´¢ï¼šåŸºäºå‘é‡ç›¸ä¼¼æ€§è€Œéå…³é”®è¯åŒ¹é…
    - ä¸Šä¸‹æ–‡ä¼˜åŒ–ï¼šé€šè¿‡é‡æ’åºæå‡ç›¸å…³æ€§
    - å¤šæ–‡æ¡£èåˆï¼šæ•´åˆå¤šä¸ªç›¸å…³æ–‡æ¡£ç‰‡æ®µ
    - æ™ºèƒ½ç”Ÿæˆï¼šLLM åŸºäºä¸Šä¸‹æ–‡è¿›è¡Œæ¨ç†å’Œå›ç­”
    """
    # æ­¥éª¤1-3ï¼šæ£€ç´¢ç›¸å…³æ–‡æ¡£ï¼ˆå·²ç”± compression_retriever å®Œæˆï¼‰
    # è¿™ä¸€æ­¥åŒ…æ‹¬ï¼šæŸ¥è¯¢å‘é‡åŒ– â†’ ç›¸ä¼¼æ€§æœç´¢ â†’ é‡æ’åºä¼˜åŒ–
    docs = compression_retriever.invoke(query)
    
    # æ­¥éª¤4ï¼šé€‰æ‹©å‰3ä¸ªæœ€ç›¸å…³çš„æ–‡æ¡£å¹¶ç»„åˆä¸ºä¸Šä¸‹æ–‡
    # ä½¿ç”¨åˆ†éš”ç¬¦è¿æ¥å¤šä¸ªæ–‡æ¡£ï¼Œä¾¿äº LLM ç†è§£æ–‡æ¡£è¾¹ç•Œ
    base_document = "\n---------".join([d.page_content for d in docs[:3]])
    
    # æ­¥éª¤5ï¼šæ„å»ºå¯¹è¯æ¶ˆæ¯
    messages = [
        # ç³»ç»Ÿæ¶ˆæ¯ï¼šæŒ‡å¯¼ LLM å¦‚ä½•ä½¿ç”¨æä¾›çš„æ–‡æ¡£
        SystemMessage(content="Given document, use these documents to answer query"),
        # ç”¨æˆ·æ¶ˆæ¯ï¼šåŒ…å«æŸ¥è¯¢å’Œæ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£
        HumanMessage(content=f"Query: {query}\nDocument: {base_document}")
    ]
    
    # æ­¥éª¤6ï¼šä½¿ç”¨ LLM ç”Ÿæˆå›ç­”
    ai_msg = llm.invoke(messages)
    return ai_msg.content

# ==================== æ¼”ç¤ºå’Œæµ‹è¯• ====================
if __name__ == "__main__":
    """
    Vector-based RAG ç³»ç»Ÿæ¼”ç¤º
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - å±•ç¤ºå¦‚ä½•ä½¿ç”¨å‘é‡ RAG ç³»ç»Ÿå›ç­”åŸºäºæ–‡æ¡£çš„é—®é¢˜
    - ç¤ºä¾‹æŸ¥è¯¢æ¶‰åŠè´¢åŠ¡æ•°æ®çš„å…·ä½“åˆ†æ
    - æ¼”ç¤ºç³»ç»Ÿå¦‚ä½•ä»å¤§é‡æ–‡æ¡£ä¸­ç²¾ç¡®æ£€ç´¢ç›¸å…³ä¿¡æ¯
    
    ç³»ç»Ÿä¼˜åŠ¿ï¼š
    1. å¿«é€Ÿæ£€ç´¢ï¼šåŸºäºå‘é‡ç›¸ä¼¼æ€§çš„é«˜æ•ˆæœç´¢
    2. ç²¾ç¡®åŒ¹é…ï¼šè¯­ä¹‰ç†è§£èƒ½åŠ›å¼ºï¼Œä¸ä¾èµ–å…³é”®è¯åŒ¹é…
    3. ä¸Šä¸‹æ–‡ä¿æŒï¼šé€šè¿‡æ–‡æ¡£åˆ†å—å’Œé‡å ä¿æŒä¿¡æ¯å®Œæ•´æ€§
    4. ç»“æœä¼˜åŒ–ï¼šé‡æ’åºæœºåˆ¶æå‡æ£€ç´¢è´¨é‡
    5. æ‰©å±•æ€§å¼ºï¼šå¯å¤„ç†å¤§è§„æ¨¡æ–‡æ¡£é›†åˆ
    
    é€‚ç”¨åœºæ™¯ï¼š
    - æ–‡æ¡£é—®ç­”ç³»ç»Ÿ
    - çŸ¥è¯†åº“æ£€ç´¢
    - æŠ€æœ¯æ–‡æ¡£æŸ¥è¯¢
    - æ³•å¾‹æ¡æ–‡æ£€ç´¢
    - å­¦æœ¯è®ºæ–‡åˆ†æ
    """
    
    # ç¤ºä¾‹æŸ¥è¯¢ï¼šå…³äº UnitedHealth Group è´¢åŠ¡å˜åŒ–çš„å¤æ‚é—®é¢˜
    query = "What factors contributed to the changes in UnitedHealth Group's revenues and net earnings from 2023 to 2024, and how did these changes affect the earnings per share attributable to UnitedHealth Group common shareholders?"
    
    print("ğŸš€ Vector-based RAG ç³»ç»Ÿå¯åŠ¨")
    print("ğŸ” å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢...")
    print(f"ğŸ“ æŸ¥è¯¢é—®é¢˜: {query}")
    print("\n" + "="*80)
    
    # æ‰§è¡ŒæŸ¥è¯¢å¹¶è·å–å›ç­”
    response = run_vector_rag_query(query)
    
    print(f"ğŸ¤– Vector-based RAG å›ç­”:")
    print(f"{response}")
    print("\n" + "="*80)
    print("âœ… æŸ¥è¯¢å®Œæˆ")